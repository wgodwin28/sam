---
title: "SAM Weekly Report"
subtitle:
- <h1><u>CONFIDENTIAL-DO NOT DISSEMINATE</u></h1>
author: "Will Godwin"
date: "`r format(Sys.time(), '%d %B %Y')`"
geometry: margin=2cm
header-includes:
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{wrapfig}
- \usepackage{float}
- \usepackage{colortbl}
- \usepackage{pdflscape}
- \usepackage{tabu}
- \usepackage{threeparttable}
- \usepackage{threeparttablex}
- \usepackage[normalem]{ulem}
- \usepackage{makecell}
- \usepackage{xcolor}
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = paste0(substr(inputFile,1,nchar(inputFile)-4), "_", Sys.Date(),'.pdf')) })
always_allow_html: yes
output:
  pdf_document:
    toc: true
    toc_depth: 2
    template: default.latex
---

```{r, echo=FALSE}
#Purpose: validate incoming data collected for GAMIN study

#Additions to make:

```


```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE)
# clear memory
rm(list=ls())
options(max.print = 10000)
date <- format(Sys.Date(), "%d%b%Y")
#date <- "23Jun2020"

#disable scientific notation
options(scipen = 999)

# configure directories, load libraries and base functions
source(paste0(here::here(), "/monitoring/code/functions/config.R"))

#load utility package full of necessary functions
#devtools::load_all('~/Desktop/utility/')
```

```{bash run api, eval=F, echo=F, message=F}
# bash script to export all the dataz
commcare-export --output-format csv --output ../../data/raw/temp.zip --project nouna-pilots --query ../../tables/api_metadata.xlsx --username william.godwin@ucsf.edu --password Mordor2018! --since 2020-06-01
```

```{r, echo=F}
# unzip zip file
date <- format(Sys.Date(), "%d%b%Y")
zipF <- paste0(data_dir, "temp.zip")
unzip(zipF, exdir=paste0(data_dir, date))
```

```{r read data, include=F}
source(paste0(code_dir, "read_data.R"), local = T)
```

```{r overview, include=F}
# number of csps
overall_rowno <- pluck(df_list, "eligibility") %>% distinct(csps_fra) %>% nrow + 1

# eligibility criteria
el_crit <- c("abx_use", "clin_comp", "inpatient", "edema", "growth_faltering_illness", 
             "prior__admission", "feeding", "Study_area", "available", "consent")

# create screened indicator
pluck(df_list, "eligibility") %<>%
  mutate(screened = if_else(!duplicated(childID) | is.na(childID), 1, 0),
         eligible = if_else(str_detect(inclusion_criteria, el_crit) & (muac_under115==1 | whz_zscore_ind==1), 1, 0),
         refused = if_else(eligible==1 & is.na(childID), 1, 0), # need to edit this once we know what refusal looks like
         enrolled = if_else(!is.na(childID), 1, 0)) #,
         #excluded_reasons = grep(inclusion_criteria, paste(el_crit, collapse = "|"), value = T, invert = T))
    
# tabulate the indicators and create table
temp.table <- 
  bind_rows(
    pluck(df_list, "eligibility") %>%
    group_by(CSPS=csps_fra) %>%
    summarise(Screened = sum(screened, na.rm = T),
              Eligible = sum(eligible, na.rm = T),
              Refused = sum(refused, na.rm = T),
              Enrolled = sum(enrolled, na.rm = T)),
    pluck(df_list, "eligibility") %>%
    summarise(Screened = sum(screened, na.rm = T),
              Eligible = sum(eligible, na.rm = T),
              Refused = sum(refused, na.rm = T),
              Enrolled = sum(enrolled, na.rm = T)) %>%
    mutate(CSPS="Overall")
  ) %>%
  kable("latex", align = "c") %>%
  row_spec(c(0, overall_rowno), bold=T)

# tabulate the indicators for past 7 days and create table
temp.table2 <- 
  bind_rows(
    pluck(df_list, "eligibility") %>%
    filter(Sys.Date() - interview_date < 7) %>%
    group_by(CSPS=csps_fra) %>%
    summarise(Screened = sum(screened, na.rm = T),
              Eligible = sum(eligible, na.rm = T),
              Refused = sum(refused, na.rm = T),
              Enrolled = sum(enrolled, na.rm = T)),
    pluck(df_list, "eligibility") %>%
    filter(Sys.Date() - interview_date < 7) %>%
    summarise(Screened = sum(screened, na.rm = T),
              Eligible = sum(eligible, na.rm = T),
              Refused = sum(refused, na.rm = T),
              Enrolled = sum(enrolled, na.rm = T)) %>%
    mutate(CSPS="Overall")
  ) %>%
  kable("latex", align = "c") %>%
  row_spec(c(0), bold=T)

# display number
DN <- 1

# add one function
add_one <- function(x) x + 1
```

\newpage

# Overview
Data exported from CommCare on **`r format(Sys.time(), '%d %B %Y')`**

### Enrollment counts-total (Display `r DN`): `r  temp.table`
```{r, echo=F}
# display number
DN <- add_one(DN)
```

### Enrollment counts-past 7 days (Display `r DN`): `r  temp.table2`

\vspace{2em}

```{r, echo=F}
# display number
DN <- add_one(DN)
```

## Enrollment over time (Display `r DN`)
```{r time series enrollment plot, echo=F, warning=F, message=F}
#daily enrollments over time
total_perday <- pluck(df_list, "eligibility") %>%
  group_by(interview_date) %>%
  summarise(Screened = sum(screened), 
            Eligible = sum(eligible),
            Enrolled = sum(enrolled))
  
#Melt to long for ggplot
total_perday %<>%
  gather(key = "Key", value = "Value", Screened, Eligible, Enrolled) %>%
  group_by(Key) %>%
  mutate(total=cumsum(Value)) %>%
  arrange(Key, interview_date)

#plot
total_perday$Step <- factor(total_perday$Key, levels=c("Screened", "Eligible", "Enrolled"))
ggplot(total_perday, aes(x = interview_date, y = as.integer(total), color = Step)) +  
  scale_color_brewer(palette="Set1", name="") +
  geom_line(alpha=.5) +
  geom_point() +
  #geom_text(aes(label=count), vjust=-0.3, size=3.5) +
  xlab("Date") +
  ylab("Total participants") +
  scale_y_continuous(breaks= pretty_breaks()) +
  scale_x_date(labels = date_format("%m/%d"), breaks = date_breaks("3 day")) +
  theme(legend.title = element_blank()) +
  #scale_color_discrete(name="") +
  theme_bw()
```

\vspace{2em}

```{r, echo=F}
# display number
DN <- add_one(DN)
```

## CONSORT Diagram (Display `r DN`)
```{r consort diagram, echo=F, warning=F}
# Values
con_screened <- pluck(df_list, "eligibility") %>% summarise(sum(screened, na.rm = T)) %>% pull
con_eligible <- pluck(df_list, "eligibility") %>% summarise(sum(eligible, na.rm = T)) %>% pull
con_ineligble <- con_screened - con_eligible
con_enrolled <- pluck(df_list, "eligibility") %>% summarise(sum(enrolled, na.rm = T)) %>% pull
con_notenrolled <- con_eligible - con_enrolled
con_treated <- pluck(df_list, "treatment") %>% filter(admin_treatment==1) %>% distinct(childID) %>% nrow
con_lostfollowup <- pluck(df_list, "followup") %>% 
  filter(time_point=="week_8" & (vital_status=="moved" | vital_status=="unknown")) %>%
  distinct(childID) %>% nrow
con_reach6mo <- pluck(df_list, "followup") %>% 
  filter(time_point=="week_8" & vital_status=="alive") %>%
  distinct(childID) %>% nrow
values <- c(con_screened, con_ineligble, con_eligible, con_notenrolled,
            con_enrolled, con_lostfollowup, con_reach6mo)
#values <- c(210, 10, 200, 100, 100, 10, 60)

# Text Labels-must be same length as values above
text <- c("Assessed for\neligibility",
          "Ineligible",
          "Eligible",
          "Refused/\nNot enrolled",
          "Randomized",
          "Lost to Follow-up",
          "Reached 8-week \noutcome")

#generate data for flowchart
consort_data <- paste0(text, "(N=", values, ")")
#substitute(paste0(text, "(", italic("N="), values, ")"))
#consort_data <- paste0(text, "(", substitute(paste0(italic("N="))), values, ")")
generate_consort(consort_data)
```

**Lost to Follow-up**-total participants with "moved" or "unknown" vital status at week 8.

```{r, echo=F}
# display number
DN <- add_one(DN)
```

\newpage

## Reasons ineligible (Display `r DN`)
```{r, echo=F, message=F, warning=F}
# identify each reason for exclusion
pluck(df_list, "eligibility") %<>%
  mutate(exclz_abx_use = if_else(str_detect(inclusion_criteria, "abx_use"), 0, 1),
         exclz_clin_comp = if_else(str_detect(inclusion_criteria, "clin_comp"), 0, 1),
         exclz_inpatient = if_else(str_detect(inclusion_criteria, "inpatient"), 0, 1),
         exclz_edema = if_else(str_detect(inclusion_criteria, "edema"), 0, 1),
         exclz_growth_faltering_illness = if_else(str_detect(inclusion_criteria, "growth_faltering_illness"), 0, 1),
         exclz_prior__admission = if_else(str_detect(inclusion_criteria, "prior__admission"), 0, 1),
         exclz_feeding = if_else(str_detect(inclusion_criteria, "feeding"), 0, 1),
         exclz_Study_area = if_else(str_detect(inclusion_criteria, "Study_area"), 0, 1),
         exclz_available = if_else(str_detect(inclusion_criteria, "available"), 0, 1),
         exclz_consent = if_else(str_detect(inclusion_criteria, "consent"), 0, 1))

# tabulate
df_reasons <-
  bind_rows(
    pluck(df_list, "eligibility") %>%
      group_by(csps_fra) %>%
      summarise_at(vars(contains("exclz")), sum),
    pluck(df_list, "eligibility") %>%
      summarise_at(vars(contains("exclz")), sum) %>%
      mutate(csps_fra="Overall")
  )

# split data into 2 bc too wide for one table
df_reasons %>%
  select(csps_fra, exclz_abx_use, exclz_clin_comp, exclz_inpatient, exclz_edema, exclz_growth_faltering_illness) %>%
  kable("latex", align = "c", col.names = c("CSPS", "Antibiotic use", "Clinical comp", "Inpatient", "Edema", "GFI")) %>%
  row_spec(c(0, overall_rowno), bold=T)

# second half of table
df_reasons %>%
  select(csps_fra, exclz_prior__admission, exclz_feeding, exclz_Study_area, exclz_available, exclz_consent) %>%
  kable("latex", align = "c", col.names = c("CSPS", "Prior admission", "Feeding", "Study area", "Unavailable", "Refused")) %>%
  row_spec(c(0, overall_rowno), bold=T)
```

**Antibiotic use** = antibiotic use in past 7 days. **Clinical comp** = complications required antibiotic use. **Inpatient** = complications requiring inpatient treatment. **GFI** = Growth faltering illness. **Edema** = nutritional edema. **Prior admission** = prior admission to nutritional program in past 3 months. **Feeding** = insufficient appetite according to a feeding test with ready-to-use therapeutic food. **Study area** = child does not live in study area. **Available** = available for next 8 weeks.

\vspace{2em}

```{r, echo=F}
# display number
DN <- add_one(DN)
```

# Baseline characteristics (Display `r DN`)
```{r, echo=F, message=F, warning=F}
# build anthro plots
make_plotly <- F
source(paste0(code_dir, "plot_anthro.R"), local = T)

# produce formatted mean and standard deviation of vector
mean_sd <- function(x){
  # mean
  m <- mean(x, na.rm = T) %>% round(1)
  
  # standard deviation
  s <- sd(x, na.rm = T) %>% round(1)
  
  # return formatted product
  return(paste0(m, " (", s, ")"))
}

# function that produces sum and percent of binary vector input
sum_n_percent <- function(x){
  s <- sum(x, na.rm = T)
  
  per <- percent(sum(x, na.rm = T)/length(x))
  
  return(paste0(s, " (", per, ")"))
}

# child and mother's age
age <- pluck(df_list, "baseline") %>%
  mutate(age_months = as.integer(age_months),
         age_months = ifelse(Dob_known==1, difftime(Sys.Date(), child_dob)/30, age_months)) %>%
  summarize("Child age (months), mean (SD)" = mean_sd(age_months),
            "Mother's age (years), mean (SD)" = mean_sd(mothers_age)) %>%
  pivot_longer(everything()) %>%
  select(col1=name, col2=value)

# calculate percent female
female <- pluck(df_list, "baseline") %>%
  mutate(sex2=if_else(sex=="male", 0, 1),
         col1="Female sex, N (%)") %>%
  group_by(col1) %>%
  summarize(col2=sum_n_percent(sex2))

# calculate percent currently breastfeeding
breastfed <- pluck(df_list, "baseline") %>%
  mutate(breast_fed=case_when(
    breastfeed == 1 ~ 1,
    breastfeed == 2 ~ 0
  ),
    col1="Breastfeeding, N (%)") %>%
  group_by(col1) %>%
  summarize(col2=sum_n_percent(breast_fed))

# calculate anthro measurements
anthro <- pluck(df_list, "anthro") %>%
  filter(time_point=="baseline") %>%
  summarise("MUAC, mean (SD)" = mean_sd(muac),
            "WHZ, mean (SD)" = mean_sd(whz_zscore),
            "WAZ, mean (SD)" = mean_sd(waz_zscore),
            "HAZ, mean (SD)" = mean_sd(haz_zscore)) %>%
  pivot_longer(everything()) %>%
  select(col1=name, col2=value)

# bind together
bind_rows(age,
          female,
          breastfed,
          anthro) %>%
  kable("latex", col.names = c(" ", " "))
```

```{r, echo=F, warning=F}
# calculate percent female
female <- pluck(df_list, "baseline") %>%
  mutate(sex2=if_else(sex=="male", 0, 1)) %>%
  summarize(Female=percent(mean(sex2, na.rm = T)))

# calculate percent currently breastfeeding
breastfed <- pluck(df_list, "baseline") %>%
  mutate(breast_fed=case_when(
    breastfeed == 1 ~ 1,
    breastfeed == 2 ~ 0
  )) %>%
  summarize("Breastfeeding"=percent(mean(breast_fed, na.rm = T)))

# calculate age groups: 1-5 months, 6-11 months, 12-23 months, 24-59 months
ages <- pluck(df_list, "baseline") %>%
  mutate(
    age_months = as.integer(age_months),
    age_months = ifelse(Dob_known==1, difftime(Sys.Date(), child_dob)/30, age_months)) %>%
  mutate(age_months2 = case_when(
    age_months<6 ~ "1-5 months",
    age_months<12 ~ "6-11 months",
    age_months<24 ~ "12-23 months",
    age_months<60 ~ "24-59 months"
  ),
    num=1,
    id = row_number()) %>%
  select(age_months2, num, id) %>%
  spread(key = age_months2, value=num, fill=0) %>%
  summarise_if(is.numeric, mean) %>%
  mutate_all(percent) %>%
  select(contains("months"))

# get total number
total <- pluck(df_list, "baseline") %>%
  summarise(Total=n())

# bind together and table
bind_cols(female, ages, breastfed, total) %>%
  kable("latex") %>%
  row_spec(0, bold=T)
  # column_spec(c(2,3,4,5), background = "#f0f0f0") %>%
  # row_spec(c(0), bold=TRUE) %>%
  # column_spec(c(2), border_left = T) %>%
  # column_spec(c(5), border_right = T)
```
**Breastfeeding** = currently breastfeeding.

```{r, echo=F}
# display number
DN <- add_one(DN)
```

## Age Distribution (Display `r DN`)
```{r, echo=F, message=F}
#age histogram
pluck(df_list, "anthro") %>%
  filter(time_point=="baseline") %>%
  mutate(age_months = ifelse(Dob_known==1, difftime(Sys.Date(), child_dob)/30, age_months)) %>%
  ggplot(aes(age_months)) +
  geom_histogram() +
  theme_bw() +
  scale_x_continuous(breaks = seq(0,60,6)) +
  xlab("Age (Months)") +
  ylab("Count")
```

Histogram distribution of the age at enrollment.

\vspace{1em}

```{r, echo=F}
# display number
DN <- add_one(DN)
```

# Anthropometry (Display `r DN`)
```{r, echo=F, message=F}
# make anthro indicators
pluck(df_list, "anthro") %<>%
  mutate(whz3=if_else(whz_zscore < -3, 1, 0),
         muac11=if_else(muac < 11.5, 1, 0),
         waz3=if_else(waz_zscore < -3, 1, 0),
         haz3=if_else(haz_zscore < -3, 1, 0))

# number of csps
overall_rowno <- pluck(df_list, "anthro") %>% distinct(csps_fra) %>% nrow + 1

#tabulate and table
bind_rows(
  pluck(df_list, "anthro") %>%
    filter(time_point=="baseline") %>%
    group_by(csps_fra) %>%
    summarise(sum_n_percent(whz3),
              sum_n_percent(muac11),
              sum_n_percent(waz3),
              sum_n_percent(haz3)),
  pluck(df_list, "anthro") %>%
    filter(time_point=="baseline") %>%
    summarise(sum_n_percent(whz3),
              sum_n_percent(muac11),
              sum_n_percent(waz3),
              sum_n_percent(haz3)) %>%
    mutate(csps_fra="Overall")
  ) %>%
  kable("latex", col.names = c("CSPS", "WHZ < -3", "MUAC < 11.5", "WAZ < -3",
                               "HAZ < -3")) %>%
  row_spec(c(0, overall_rowno), bold=T)
```
Total and percentage of participants that report WAZ < -3 SD (standard deviation), MUAC < -11.5 cm, WHZ < -3 SD, and HAZ < -3 SD.

\newpage

```{r, echo=F}
# display number
DN <- add_one(DN)
```

## Weight versus age (Display `r DN`)
```{r, echo=F, message=F, warning=F, fig.height = 4.35, fig.width = 6.5}
#plot wfa males
p_male_wfa
```

```{r, echo=F, message=F, warning=F, fig.height = 4.35, fig.width = 6.5}
#plot wfa females
p_female_wfa
```

```{r, echo=F}
# display number
DN <- add_one(DN)
```

## Height versus age (Display `r DN`)
```{r, echo=F, message=F, warning=F, fig.height = 4.35, fig.width = 6.5}
#plot hfa males
p_male_hfa
```

```{r, echo=F, message=F, warning=F, fig.height = 4.35, fig.width = 6.5}
#plot hfa females
p_female_hfa
```

```{r, echo=F}
# display number
DN <- add_one(DN)
```

## Weight versus height (Display `r DN`)
```{r, echo=F, message=F, warning=F, fig.height = 4.35, fig.width = 6.5}
#plot wfh males: 0-2 years
p_male_wfh_2
```

```{r, echo=F, message=F, warning=F, fig.height = 4.35, fig.width = 6.5}
#plot wfh females: 0-2 years
p_female_wfh_2
```

```{r, echo=F}
# display number
DN <- add_one(DN)
```

## Weight versus height cont'd (Display `r DN`)
```{r, echo=F, message=F, warning=F, fig.height = 4.35, fig.width = 6.5}
#plot wfh males: 3-5 years
p_male_wfh_5
```

```{r, echo=F, message=F, warning=F, fig.height = 4.35, fig.width = 6.5}
#plot wfh females: 3-5 years
p_female_wfh_5
```

```{r, echo=F}
# display number
DN <- add_one(DN)
```

## MUAC versus age (Display `r DN`)
```{r, echo=F, message=F, warning=F, fig.height = 4.35, fig.width = 6.5}
#plot mfa males
p_male_mfa
```

```{r, echo=F, message=F, warning=F, fig.height = 4.35, fig.width = 6.5}
#plot mfa females
p_female_mfa
```

```{r, echo=F}
# display number
DN <- add_one(DN)
```

## Growth Curves
### Height for Age (Display `r DN`)
```{r, echo=F, message=F, warning=F, fig.height = 4.35, fig.width = 6.5}
#plot height males
#p_male_grow_h
p_male_study_haz
```

Growth curves of individual participants over the study period. Each line represents one participant.


```{r, echo=F, message=F, warning=F, fig.height = 4.35, fig.width = 6.5}
#plot height females
#p_female_grow_h
p_female_study_haz
```

Growth curves of individual participants over the study period. Each line represents one participant.

```{r, echo=F}
# display number
DN <- add_one(DN)
```

### Weight for Age (Display `r DN`)
```{r, echo=F, message=F, warning=F, fig.height = 4.35, fig.width = 6.5}
#plot weight males
#p_male_grow_w
p_male_study_waz
```

Growth curves of individual participants over the study period. Each line represents one participant.

```{r, echo=F, message=F, warning=F, fig.height = 4.35, fig.width = 6.5}
#plot weight females
#p_female_grow_w
p_female_study_waz
```

Growth curves of individual participants over the study period. Each line represents one participant.

```{r, echo=F}
# display number
DN <- add_one(DN)
```

### Weight for Height (Display `r DN`)

```{r, echo=F, message=F, warning=F, fig.height = 4.35, fig.width = 6.5}
#plot whz males
p_male_study_whz
```

```{r, echo=F, message=F, warning=F, fig.height = 4.35, fig.width = 6.5}
#plot whz females
p_female_study_whz
```

```{r, echo=F}
# display number
DN <- add_one(DN)
```

### MUAC for Age (Display `r DN`)
```{r, echo=F, message=F, warning=F, fig.height = 4.35, fig.width = 6.5}
#p_male_grow_m
p_male_study_muac
```

Growth curves of individual participants over the study period. Each line represents one participant.


```{r, echo=F, message=F, warning=F, fig.height = 4.35, fig.width = 6.5}
#p_female_grow_m
p_female_study_muac
```

Growth curves of individual participants over the study period. Each line represents one participant.

```{r, echo=F}
# display number
DN <- add_one(DN)
```

## Weight gain velocity (Display `r DN`)
```{r, echo=F, warning=F}
# number of csps
overall_rowno <- pluck(df_list, "baseline") %>% distinct(csps_fra) %>% nrow + 1

temp <- inner_join(
  # calculate weight gain velocity
  pluck(df_list, "anthro") %>%
    select(childID, time_point, weight) %>% 
    pivot_wider(names_from = time_point, values_from = weight, values_fn = list(weight = mean)) %>%
    # convert to grams and adjust for baseline weight
    mutate_at(vars(-matches("childID"), -matches("baseline")), list(dif = ~ ((. - baseline)*1000)/baseline)) %>%
    select(childID, contains("dif")),
  
  # calculate total days between each visit
  pluck(df_list, "anthro") %>%
    select(childID, time_point, start_time) %>%
    pivot_wider(names_from = time_point, values_from = start_time, values_fn = list(start_time = mean)) %>%
    mutate_at(vars(-matches("childID"), -matches("baseline")), list(days = ~ as.integer(. - baseline))) %>%
    select(childID, contains("days")),
  
  by="childID"
) %>%
  mutate(week_1_vel=week_1_dif/week_1_days,
         week_2_vel=week_2_dif/week_2_days,
         week_3_vel=week_3_dif/week_3_days,
         week_4_vel=week_4_dif/week_4_days)

# tabulate the mean/SD velocity by CSPS
bind_rows(
  left_join(temp, 
            pluck(df_list, "baseline") %>% distinct(childID, csps_fra),
            by="childID") %>%
  group_by(csps_fra) %>%
  summarise(week_1=mean_sd(week_1_vel),
            week_2=mean_sd(week_2_vel),
            week_3=mean_sd(week_3_vel),
            week_4=mean_sd(week_4_vel)),
  temp %>%
    summarise(week_1=mean_sd(week_1_vel),
              week_2=mean_sd(week_2_vel),
              week_3=mean_sd(week_3_vel),
              week_4=mean_sd(week_4_vel)) %>%
    mutate(csps_fra="Overall")
) %>%
  # table it
  kable("latex", col.names = c("CSPS", "Week 1", "Week 2", "Week 3", "Week 4")) %>%
  row_spec(c(0, overall_rowno), bold=T)

if(Sys.Date() > as.Date("2020-07-12")){
  message("ADD WEEK 5 VELOCITY")
}
```
Table shows average (standard deviation) weight gain velocity in grams/kilogram/day with respect to baseline.


```{r, echo=F}
# display number
DN <- add_one(DN)
```

# Treatment (Display `r DN`)
```{r, echo=F, message=F, warning=F}
# number of csps
overall_rowno <- pluck(df_list, "treatment") %>% distinct(csps_fra) %>% nrow + 1

# tabulate number of treated and table
bind_rows(
  pluck(df_list, "treatment") %>%
    group_by(CSPS=csps_fra) %>%
    summarise("Total treated"=sum(admin_treatment, na.rm = T)),
  pluck(df_list, "treatment") %>%
    summarise("Total treated"=sum(admin_treatment, na.rm = T)) %>%
    mutate(CSPS="Overall")
) %>%
  kable("latex") %>%
  row_spec(c(0, overall_rowno), bold=T)
```

```{r, echo=F}
# display number
DN <- add_one(DN)
```

# Malaria-rapid diagnostic test results (Display `r DN`)
```{r, echo=F, message=F, warning=F}
# number of csps
overall_rowno <- pluck(df_list, "malaria") %>% distinct(csps_fra) %>% nrow + 1

# number of TDR per CSPS
pluck(df_list, "malaria") %<>%
  mutate(total=1,
         positive=if_else(malaria_rdt_result=="positive", 1, 0),
         negative=if_else(malaria_rdt_result=="negative", 1, 0),
         missing=if_else(malaria_rdt_result=="not_done", 1, 0),
         invalid=if_else(malaria_rdt_result=="invalid", 1, 0))

bind_rows(
  pluck(df_list, "malaria") %>%
    group_by(CSPS=csps_fra, time_point) %>%
    summarise(sum(total),
              sum_n_percent(positive),
              sum_n_percent(negative),
              sum_n_percent(missing),
              sum_n_percent(invalid),
              sum_n_percent(hb_test)),
  pluck(df_list, "malaria") %>%
    summarise(sum(total),
              sum_n_percent(positive),
              sum_n_percent(negative),
              sum_n_percent(missing),
              sum_n_percent(invalid),
              sum_n_percent(hb_test)) %>%
    mutate(CSPS="Overall")
) %>%
  kable("latex", col.names = c("CSPS", "Timepoint", "Total", "Positives", "Negatives",
                               "Missing", "Invalid", "HB Test")) %>%
  row_spec(c(0, overall_rowno), bold=T)
```
**HB Test** = "Total hemoglobin tests performed"

```{r, echo=F, eval=F, message=F, warning=F}
## Hemoglobin test (Display 14)
pluck(df_list, "malaria") %>%
  group_by(CSPS=csps_fra, time_point) %>%
    summarise(sum(total),
              sum_n_percent(positive),
              sum_n_percent(negative),
              sum_n_percent(missing),
              sum_n_percent(invalid),
              sum_n_percent(hb_test)),
  pluck(df_list, "malaria") %>%
    summarise(sum(total),
              sum_n_percent(positive),
              sum_n_percent(negative),
              sum_n_percent(missing),
              sum_n_percent(invalid),
              sum_n_percent(hb_test)) %>%
    mutate(CSPS="Overall")
```

```{r, echo=F}
# display number
DN <- add_one(DN)
```

# Rectal swabs (Display `r DN`)
```{r, echo=F, message=F, warning=F}
# number of csps
overall_rowno <- pluck(df_list, "rectal") %>% distinct(csps_fra) %>% nrow + 1

# check if swab was collected
pluck(df_list, "rectal") %<>%
  mutate(performed = case_when(
    rectal_ID_option==3 ~ 0,
    rectal_ID_option %in% c(1,2) ~ 1))

# tabulate number of rectal swabs
bind_rows(
  pluck(df_list, "rectal") %>%
    group_by(CSPS=csps_fra) %>%
    summarise(selected=sum(rectal_alloc),
              performed=sum(performed, na.rm = T)),
  pluck(df_list, "rectal") %>%
    summarise(selected=sum(rectal_alloc),
              performed=sum(performed, na.rm = T)) %>%
    mutate(CSPS="Overall")
) %>%
  mutate(coverage=percent(performed/selected)) %>%
  kable("latex", col.names = c("CSPS", "Participants selected", "Swabs performed", "Coverage")) %>%
  row_spec(c(0, overall_rowno), bold=T)
```

Total participants randomly selected for rectal swab by CSPS

\newpage

```{r, echo=F}
# display number
DN <- add_one(DN)
```

# General Follow-up
## Actual to expected ratio-Vital status form (Display `r DN`)
```{r, echo=F, message=F, warning=F}
# make child ID unique key in follow-up forms
pluck(df_list, "anthro") %<>% mutate(uniqID=paste0(childID, "_", time_point))
pluck(df_list, "followup") %<>% mutate(uniqID=paste0(childID, "_", time_point))

# tabulate lost to followup by timepoint
df_ltfu <- pluck(df_list, "followup") %>%
  filter(!duplicated(uniqID)) %>%
  mutate(ltfu=if_else(vital_status %in% c("moved", "unknown"), 1, 0)) %>%
  group_by(time_point) %>%
  summarize(ltfu=sum(ltfu))

# tabulate number with discharge form submitted
df_dis <- pluck(df_list, "discharge") %>%
  left_join(., pluck(df_list, "eligibility") %>% select(childID, enroll_date=start_time), by="childID") %>% 
  mutate(time_point=as.numeric(difftime(as.Date(start_time), enroll_date, units = "weeks")),
         time_point=paste0("week_", time_point),
         time_point=ifelse(time_point=="week_0", "baseline", time_point),
         time_point=as.character(time_point),
         discharge=1) %>%
  group_by(time_point) %>%
  summarise(discharge=sum(discharge))

# expected to actual ratio for weeks 5-7 (exclude discharged kids)
discharge_ids <- pluck(df_list, "discharge") %>% distinct(childID) %>% pull
df_5to7 <- pluck(df_list, "eligibility") %>%
  filter(enrolled==1 & childID %in% setdiff(childID, discharge_ids)) %>%
  select(childID, enroll_date=start_time, csps_fra, child_firstname) %>%
  mutate("week_5"=if_else(Sys.Date()-enroll_date>=35, 1, 0),
         "week_6"=if_else(Sys.Date()-enroll_date>=42, 1, 0),
         "week_7"=if_else(Sys.Date()-enroll_date>=49, 1, 0)) %>%
  gather(key = time_point, value = expected, -enroll_date, -childID, -csps_fra, -child_firstname) %>%
  left_join(., 
            pluck(df_list, "followup") %>% 
              filter(!duplicated(uniqID)) %>%
              select(id, childID, time_point), 
            by=c("childID", "time_point")) %>%
  select(childID, enroll_date, time_point, expected, id, csps_fra, child_firstname)

# expected to actual ratio
df_followup <- pluck(df_list, "eligibility") %>%
  filter(enrolled==1) %>%
  select(childID, enroll_date=start_time, csps_fra, child_firstname) %>%
  #identify expected visits based on today's date and enroll date
  mutate("week_1"=if_else(Sys.Date()-enroll_date>=7, 1, 0),
         "week_2"=if_else(Sys.Date()-enroll_date>=14, 1, 0),
         "week_3"=if_else(Sys.Date()-enroll_date>=21, 1, 0),
         "week_4"=if_else(Sys.Date()-enroll_date>=28, 1, 0),
         "week_8"=if_else(Sys.Date()-enroll_date>=56, 1, 0)) %>%
  gather(key = time_point, value = expected, -enroll_date, -childID, -csps_fra, -child_firstname) %>%
  left_join(., 
            pluck(df_list, "followup") %>% 
              filter(!duplicated(uniqID)) %>% 
              select(id, childID, time_point), 
            by=c("childID", "time_point")) %>%
  select(childID, enroll_date, time_point, expected, id, csps_fra, child_firstname) %>%
  bind_rows(., df_5to7)

# make table of the actual to expected ratios
df_followup %>%
  group_by(time_point) %>%
  #finds the number of actual interviews by summing total non-missing interview keys
  summarise(expected=sum(expected), actual=sum(!is.na(id))) %>%
  mutate(percnt=percent(actual/expected)) %>%
  arrange(time_point) %>%
  left_join(., df_ltfu, by="time_point") %>%
  mutate(missing=ltfu+(expected-actual)) %>%
  left_join(., df_dis, by="time_point") %>%
  mutate_if(is.double, function(x) ifelse(is.na(x), 0, x)) %>%
  kable("latex", col.names = c("Timepoint", "Expected", "Actual", 
                               "Coverage", "LTFU", "Missing forms", "N discharged")) %>%
  row_spec(c(0), bold=T)
```
**LTFU** = lost to follow-up (vital status is moved/unknown).
**Coverage** = fraction of actual over expected visits.
Number expected for Weeks 5 through 7 are the number of kids who are in the week 5-7 windows and who have not had a discharge form submitted.
**Missing forms** = No follow-up form of any kind (including discharge or moved/unknown) submitted.
**N discharged** = number with discharge form submitted.

```{r, echo=F}
# display number
DN <- add_one(DN)
```

### Participants missing follow-up (Display `r DN`)
```{r, echo=F, message=F, warning=F}
# make table of kids missing follow-up
df_followup %>% 
  filter(expected==1 & is.na(id)) %>%
  arrange(csps_fra, childID, time_point) %>%
  select(csps_fra, childID, time_point, child_firstname, enroll_date) %>%
  mutate(weeks = weeks(substr(time_point, 6, 6)),
         follow_update = weeks + enroll_date,
         days_late = as.Date(date, "%d%b%Y") - follow_update) %>%
  select(-weeks, -follow_update) %>% 
  arrange(csps_fra, -days_late) %>%
  kable("latex", col.names = c("CSPS", "Child ID", "Time point", "Child name", "Enroll date", "Days late")) %>%
  row_spec(c(0), bold=T) %>%
  collapse_rows(1:2, latex_hline = 'custom', custom_latex_hline = 1:2,
                row_group_label_position = 'identity')
```

```{r, echo=F}
# display number
DN <- add_one(DN)
```

## Recovery by CSPS (Display `r DN`)
```{r, echo=F, message=F, warning=F}
# number of csps
overall_rowno <- pluck(df_list, "anthro") %>% 
  filter(time_point!="baseline" & time_point!="week_1") %>% 
  distinct(csps_fra) %>% nrow + 1

# create indicator variables whether waz and muac have remained below threshold for 2 consecutive weeks
a <- pluck(df_list, "eligibility") %>%
  mutate(rec_enroll =
           case_when(
             whz_zscore_ind==1 & muac_under115==1 ~ 3,
             muac_under115==1 ~ 1,
             whz_zscore_ind==1 ~ 2
           )
  ) %>% 
  select(rec_enroll, childID) %>%
  right_join(., pluck(df_list, "anthro") %>%
                 filter(time_point!="baseline" & time_point!="week_1"),
             by="childID") %>%
  arrange(childID, time_point) %>%
  mutate(recovered = 
           case_when(
             #if child recovers based on MUAC
             rec_enroll==1 & muac >= 12.5 & lag(muac, order_by = c(uniqID))>= 12.5 ~ 1,
             # if child recovers based on WHZ
             rec_enroll==2 & whz_zscore >= -2 & lag(whz_zscore, order_by = c(uniqID))>= -2 ~ 1,
             # if child recovers based on MUAC and WHZ
             rec_enroll==3 & muac >= 12.5 & lag(muac, order_by = c(uniqID))>= 12.5 &
               whz_zscore >= -2 & lag(whz_zscore, order_by = c(uniqID))>= -2 ~ 1,
             # else they didn't recover
             TRUE ~ 0
           )
         ) %>%
  select(waz_zscore, muac, time_point, uniqID, signs_of_malnutrition, recovered, csps_fra)

# store the ids of kids that actually have recovered
rec_ids <- a %>% mutate(childID=substr(uniqID, 0, 7)) %>% 
  filter(recovered==1) %>%
  distinct(childID) %>% pull

# add overall row and make table
bind_rows(
  # count the unique kids (IDs) that have recovered-filter out duplicates by visit
  a %>%
    mutate(childID=substr(uniqID, 0, 7)) %>%
    filter(!duplicated(childID)) %>%
    group_by(csps_fra) %>%
    summarise(visits=n(), recovered=sum(recovered)),
  a %>%
    mutate(childID=substr(uniqID, 0, 7)) %>%
    filter(!duplicated(childID)) %>%
    summarise(visits=n(), recovered=sum(recovered)) %>%
    mutate(csps_fra="Overall")
) %>%
  mutate(rec_frac=percent(recovered/visits)) %>%
  kable("latex", col.names = c("CSPS", "Visits", "Recovered", "Recovery fraction")) %>%
  row_spec(c(0, overall_rowno), bold=T)
```
**Recovered** = dependent on the enrollment reason for each child. A child was enrolled for MUAC < 115 mm must report MUAC >= 125 mm for 2 consecutive weeks. A child enrolled for WHZ < -3 must have WHZ >= -2 for 2 consecutive weeks. A child enrolled for both MUAC < 115 mm and WHZ < -3 must attain MUAC >= 125 mm AND WHZ >= -2 for 2 consecutive weeks

```{r, echo=F}
# display number
DN <- add_one(DN)
```

## Reported recoveries (Display `r DN`)
```{r, echo=F, message=F, warning=F}
# merge on the date from baseline
rec_date <- left_join(
  # list other reasons
  pluck(df_list, "discharge") %>%
    filter(reason_for_discharge=="recovered") %>%
    select(childID, csps_fra, child_firstname, start_time),
  
  # baseline date
  pluck(df_list, "baseline") %>%
    select(childID, base_time=start_time),
  by="childID"
) %>%
  mutate(week_rec = paste0("week_", round(as.numeric(difftime(start_time, base_time, units = "weeks"))))) %>%
  select(-start_time, -base_time)

# the ids of children reportedly recovered
ids <- pluck(df_list, "discharge") %>%
    filter(reason_for_discharge=="recovered") %>%
    distinct(childID) %>% pull

# make table of muac at each time point
left_join(
  pluck(df_list, "anthro") %>%
    select(childID, time_point, start_time, muac),
  pluck(df_list, "discharge") %>%
    filter(reason_for_discharge=="recovered") %>%
    select(childID, rec_time=start_time),
  by="childID"
) %>%
  filter(!is.na(rec_time)) %>%
  mutate(week_num = as.numeric(difftime(rec_time, start_time, units = "days"))) %>%
  arrange(childID, week_num) %>%
  group_by(childID) %>%
  # grab just the most recent two muac measurements
  slice_head(n = 2) %>%
  mutate(week_num = if_else(week_num < 7, "recent_muac", "next_recent_muac")) %>%
  # bind on the baseline muac
  bind_rows(., 
            pluck(df_list, "anthro") %>%
              filter(time_point=="baseline" & childID %in% ids) %>%
              select(childID, time_point, start_time, muac)
            ) %>%
  mutate(week_num = if_else(is.na(week_num), time_point, week_num),
         muac = round(muac)) %>%
  select(-time_point, -rec_time, -start_time) %>%
  pivot_wider(names_from = week_num, values_from = muac) %>%
  # add on first name, csps, recovery date
  left_join(
    .,
    rec_date,
    by="childID"
  ) %>%
  select(childID, csps_fra, child_firstname, week_rec, everything()) %>%
  mutate(recovered = if_else(childID %in% rec_ids, "Yes", "No")) %>%
  kable("latex", col.names = c("Child ID", "CSPS", "Name", "Week recovered",
                               "MUAC 1", "MUAC 2", "MUAC 0", "True recovery")) %>%
  row_spec(c(0), bold=T)
```

**MUAC 1** = MUAC at time of recovery. **MUAC 2** = MUAC at week before recovery. **MUAC 0** = MUAC at baseline. **True recovery** = recovered according to study defintion.

```{r, echo=F}
# display number
DN <- add_one(DN)
```

## Actual to expected ratio-Anthro form (Display `r DN`)
```{r, echo=F, message=F, warning=F}
# anthro expected to actual ratio
pluck(df_list, "eligibility") %>%
  filter(enrolled==1) %>%
  select(childID, start_time) %>%
  #identify expected visits based on today's date and enroll date
  mutate("week_1"=if_else(Sys.Date()-start_time>=7, 1, 0),
         "week_2"=if_else(Sys.Date()-start_time>=14, 1, 0),
         "week_3"=if_else(Sys.Date()-start_time>=21, 1, 0),
         "week_4"=if_else(Sys.Date()-start_time>=28, 1, 0)) %>%
  gather(key = time_point, value = expected, -start_time, -childID) %>%
  left_join(., 
            pluck(df_list, "anthro") %>% filter(time_point!="baseline" & !duplicated(uniqID)), 
            by=c("childID", "time_point")) %>%
  select(childID, start_time.x, time_point, expected, id) %>%
  group_by(time_point) %>%
  #finds the number of actual interviews by summing total non-missing interview keys
  summarise(expected=sum(expected), actual=sum(!is.na(id))) %>%
  mutate(percnt=percent(actual/expected)) %>%
  arrange(time_point) %>%
  kable("latex", col.names = c("Timepoint", "Expected", "Actual", "Percent")) %>%
  row_spec(c(0), bold=T)
```

```{r, echo=F}
# display number
DN <- add_one(DN)
```

## Wasting, Underweight, Stunting (Display `r DN`)
```{r, echo=F, message=F, warning=F}
# number of csps
overall_rowno <- pluck(df_list, "anthro") %>% distinct(time_point) %>% nrow

# tabulate anthro indicators (made in previous chunk) and table
bind_rows(
  pluck(df_list, "anthro") %>%
    filter(time_point!="baseline") %>%
    group_by(time_point) %>%
    summarise(sum_n_percent(muac11),
              sum_n_percent(whz3),
              sum_n_percent(waz3),
              sum_n_percent(haz3)),
  pluck(df_list, "anthro") %>%
    filter(time_point!="baseline") %>%
    summarise(sum_n_percent(muac11),
              sum_n_percent(whz3),
              sum_n_percent(waz3),
              sum_n_percent(haz3)) %>%
    mutate(time_point="Overall")
) %>%
  kable("latex", col.names = c("CSPS", "MUAC < 11.5", "WHZ < -3", "WAZ < -3",
                               "HAZ < -3")) %>%
  row_spec(c(0, overall_rowno), bold=T)
```

```{r, echo=F}
# display number
DN <- add_one(DN)
```

# Discharge (Display `r DN`)
```{r, echo=F}
# tabulate reason for exiting study
pluck(df_list, "discharge") %>%
  count(Reason=reason_for_discharge, name = "N") %>%
  kable("latex") %>%
  row_spec(0, bold=TRUE)
```

\vspace{2em}

```{r, echo=F, message=F}
# diplay discharge reason
pluck(df_list, "discharge") %>%
  select(csps_fra, childID, child_firstname, date_of_discharge, reason_for_discharge) %>%
  kable("latex", col.names = c("CSPS", "Child ID", "Child first name", "Date of discharge", "Reason")) %>%
  row_spec(0, bold=TRUE)
```

\vspace{2em}

```{r, echo=F}
# display number
DN <- add_one(DN)
```

## Other reasons for discharge (Display `r DN`)
```{r, echo=F}
# list other reasons
pluck(df_list, "discharge") %>%
  filter(reason_for_discharge=="other") %>%
  select(childID, child_firstname, csps_fra, other_reason_for_discharge) %>%
  kable("latex", col.names = c("Child ID", "Child name", "CSPS", "Reason")) %>%
  row_spec(0, bold=TRUE)
```

\newpage

```{r, echo=F}
# display number
DN <- add_one(DN)
```

# Adverse events
## Total participants displaying symptoms (Display `r DN`)
```{r, echo=F, warning=F, message=F}
# tabulate symptoms
pluck(df_list, "followup") %>%
  mutate(fever=ifelse(grepl("fever", symptoms), 1, 0),
         diarrhea=ifelse(grepl("diarrhea", symptoms), 1, 0),
         vomit=ifelse(grepl("vomiting", symptoms), 1, 0),
         ab_pain=ifelse(grepl("abdominal_pain", symptoms), 1, 0),
         rash=ifelse(grepl("skin_rash", symptoms), 1, 0),
         constipation=ifelse(grepl("constipation", symptoms), 1, 0)) %>%
  group_by(time_point) %>%
  summarise(sum_n_percent(fever),
            sum_n_percent(diarrhea),
            sum_n_percent(vomit),
            sum_n_percent(ab_pain),
            sum_n_percent(rash),
            sum_n_percent(constipation)) %>%
  kable("latex", col.names = c("Timepoint", "Fever", "Diarrhea", "Vomiting",
                               "Ab pain", "Skin rash", "Constipation")) %>%
  row_spec(c(0), bold=T)
```

```{r, echo=F}
# display number
DN <- add_one(DN)
```

### Total participants visiting health facility (Display `r DN`)
```{r, echo=F, warning=F, message=F}
# tabulate visits and reason for visits
pluck(df_list, "followup") %>%
  mutate(fever=ifelse(grepl("fever", reason_care), 1, 0),
         diarrhea=ifelse(grepl("diarrhea", reason_care), 1, 0),
         malaria=ifelse(grepl("malaria", reason_care), 1, 0),
         respiratory=ifelse(grepl("respiratory", reason_care), 1, 0),
         malnutrition=ifelse(grepl("malnutrition", reason_care), 1, 0),
         other=ifelse(grepl("other", reason_care), 1, 0)) %>%
  group_by(time_point) %>%
  summarise(sum(as.numeric(num_medcare), na.rm = T),
            sum_n_percent(fever),
            sum_n_percent(diarrhea),
            sum_n_percent(malaria),
            sum_n_percent(respiratory),
            sum_n_percent(malnutrition),
            sum_n_percent(other)) %>%
  kable("latex", col.names = c("Timepoint", "Visits", "Fever", "Diarrhea",
                               "Malaria", "Respiratory/cough", "Malnutrition", "Other")) %>%
  row_spec(c(0), bold=T)
```

```{r, echo=F}
# display number
DN <- add_one(DN)
```

### Total participants hospitalized (Display `r DN`)
```{r, echo=F, warning=F, message=F}
# tabulate visits and reason for visits
pluck(df_list, "followup") %>%
  mutate(fever=ifelse(grepl("fever", other_reason_hospital), 1, 0),
         diarrhea=ifelse(grepl("diarrhea", other_reason_hospital), 1, 0),
         malaria=ifelse(grepl("malaria", other_reason_hospital), 1, 0),
         respiratory=ifelse(grepl("respiratory", other_reason_hospital), 1, 0),
         malnutrition=ifelse(grepl("malnutrition", other_reason_hospital), 1, 0),
         other=ifelse(grepl("other", other_reason_hospital), 1, 0)) %>%
  group_by(time_point) %>%
  summarise(sum(as.numeric(hosp_num), na.rm = T),
            sum_n_percent(fever),
            sum_n_percent(diarrhea),
            sum_n_percent(malaria),
            sum_n_percent(respiratory),
            sum_n_percent(malnutrition),
            sum_n_percent(other)) %>%
  kable("latex", col.names = c("Timepoint", "Visits", "Fever", "Diarrhea",
                               "Malaria", "Respiratory/cough", "Malnutrition", "Other")) %>%
  row_spec(c(0), bold=T)
```

```{r, echo=F}
# display number
DN <- add_one(DN)
```

### List of participants hospitalized for malnutrition lacking a discharge form (Display `r DN`)
```{r, echo=F, message=F, warning=F}
# find kids w discharge form
discharge_ids <- pluck(df_list, "discharge") %>% distinct(childID) %>% pull

# filter to kids hospitalized for malnutrion w/o discharge
pluck(df_list, "followup") %>%
  filter(childID %in% setdiff(childID, discharge_ids) & 
           grepl("malnutrition", other_reason_hospital)) %>%
  select(csps_fra, child_firstname, child_dob, start_time) %>%
  kable("latex", col.names = c("CSPS", "Child name", "Child DOB", "Follow-up date")) %>%
  row_spec(0, bold=TRUE)
```

\newpage

```{r, echo=F}
# display number
DN <- add_one(DN)
```

# Child ID and sample ID validation
## Missing forms (Display `r DN`)
```{r, echo=F, message=F, warning=F}
#missing form function
find_missing <- function(df1, df2, df_list) {
  #find all IDs in df2
  ids2 <- pluck(df_list, df2) %>%
    filter(!is.na(childID) & !duplicated(childID)) %>% pull(unique(childID))
  
  #find the IDs in df1 but not df2
  ids1 <- pluck(df_list, df1) %>%
    filter(!is.na(childID)) %>%
    pull(unique(childID))
  ids_miss <- setdiff(ids1, ids2)

  #subset & table
  pluck(df_list, df1) %>%
    filter(childID %in% ids_miss) %>% select(csps_fra, childID, child_firstname) %>%
    kable("latex", col.names = c("CSPS", "Child ID", "Child first name")) %>%
    row_spec(0,bold=TRUE)
}

#run missing form function for different combinations
check1.tab <- find_missing(df1 = "eligibility", df2 = "baseline", df_list = df_list)
check2.tab <- find_missing(df1 = "baseline", df2 = "eligibility", df_list = df_list)
check3.tab <- find_missing(df1 = "baseline", df2 = "treatment", df_list = df_list)
check4.tab <- find_missing(df1 = "eligibility", df2 = "treatment", df_list = df_list)
check5.tab <- find_missing(df1 = "treatment", df2 = "eligibility", df_list = df_list)
check6.tab <- find_missing(df1 = "eligibility", df2 = "anthro", df_list = df_list)
check7.tab <- find_missing(df1 = "eligibility", df2 = "malaria", df_list = df_list)
check8.tab <- find_missing(df1 = "malaria", df2 = "eligibility", df_list = df_list)
check9.tab <- find_missing(df1 = "eligibility", df2 = "rectal", df_list = df_list)
check10.tab <- find_missing(df1 = "anthro", df2 = "eligibility", df_list = df_list)
```

### IDs in __eligibility__ form but not in __baseline__ form:
`r check1.tab`
### IDs in **baseline** form but not in **eligibility** form:
`r check2.tab`
### IDs in **eligibility** form but not in **anthro** form:
`r check6.tab`
### IDs in **anthro** form but not in **eligibility** form:
`r check10.tab`
### IDs in **baseline** form but not in **treatment** form:
`r check3.tab`
### IDs in **eligibility** form but not in **treatment** form:
`r check4.tab`
### IDs in **treatment** form but not in **eligibility** form:
`r check5.tab`
### IDs in **eligibility** form but not in **malaria** form:
`r check7.tab`
### IDs in **malaria** form but not in **eligibility** form:
`r check8.tab`
### IDs in **eligibility** form but not in **rectal swab** form:
`r check9.tab`

\vspace{2em}

```{r, echo=F}
# display number
DN <- add_one(DN)
```

### Weight change between visits >1 kg (Display `r DN`)
```{r, echo=F}
# calculate weight change between each visit
pluck(df_list, "anthro") %>%
  select(childID, time_point, weight) %>%
  pivot_wider(names_from = time_point, values_from = weight, values_fn = list(weight = mean)) %>%
  mutate(baseline = round(baseline, 2)) %>%
  mutate_at(vars(-matches("childID"), -matches("baseline")), list(dif = ~ round(. - baseline, digits = 2))) %>%
  filter_at(vars(ends_with("dif")), any_vars( . > 1)) %>%
  left_join(., 
            pluck(df_list, "baseline") %>% distinct(childID, child_firstname, csps_fra),
            by="childID") %>%
  select(csps_fra, childID, child_firstname, baseline, ends_with("dif")) %>%
  kable("latex", col.names = c("CSPS", "Child ID", "Name", "Baseline", "Week 1 change",
                               "Week 2 change", "Week 3 change", "Week 4 change")) %>%
  column_spec(1:8, width = "1.7cm") %>%
  row_spec(0, bold=T)
```

```{r, echo=F}
# display number
DN <- add_one(DN)
```

\vspace{2em}

### Height change between visits >2 cm (Display `r DN`)
```{r, echo=F}
# calculate height change between each visit
pluck(df_list, "anthro") %>%
  select(childID, time_point, height) %>%
  pivot_wider(names_from = time_point, values_from = height, values_fn = list(height = mean)) %>%
  mutate(baseline = round(baseline, 2)) %>%
  mutate_at(vars(-matches("childID"), -matches("baseline")), list(dif = ~ round(. - baseline, digits = 2))) %>%
  filter_at(vars(ends_with("dif")), any_vars( . > 2)) %>%
  left_join(., 
            pluck(df_list, "baseline") %>% distinct(childID, child_firstname, csps_fra),
            by="childID") %>%
  select(csps_fra, childID, child_firstname, baseline, ends_with("dif")) %>%
  kable("latex", col.names = c("CSPS", "Child ID", "Name", "Baseline", "Week 1 change", 
                               "Week 2 change", "Week 3 change", "Week 4 change")) %>%
  column_spec(1:8, width = "1.7cm") %>%
  row_spec(0, bold=T)
```

```{r, echo=F}
# display number
DN <- add_one(DN)
```

## Duplicate IDs
### Child IDs (Display `r DN`)
```{r, echo=F, message=F, warning=F}
#duplicate form function
find_duplicate_chids1 <- function(df_name, df_list){
  #duplicated ids in given form
  ids <- pluck(df_list, df_name) %>%
    filter(!is.na(childID) & duplicated(childID)) %>% 
    pull(unique(childID))

  #isolate the IDs and collapse with the interview keys
  pluck(df_list, df_name) %>%
    filter(childID %in% ids) %>%
    mutate(child_firstname=as.character(child_firstname)) %>%
    group_by(csps_fra, childID, child_firstname) %>%
    summarize(id=paste(id, collapse = " ")) %>%
    select(csps_fra, id, childID, child_firstname) %>%
    mutate(form=df_name)
}

# make child ID unique key in follow-up forms
pluck(df_list, "anthro") %<>% mutate(childID=paste0(childID, "_", time_point))
pluck(df_list, "followup") %<>% mutate(childID=paste0(childID, "_", time_point))

# find IDs that are duplicated
forms <- c("eligibility", "baseline", "malaria", "treatment", "rectal", "anthro", "followup") #### add anthro, followup once I create unique ID (childID + timepoint)
map_df(forms, find_duplicate_chids1, df_list) %>%
  filter(!is.na(childID)) %>%
  arrange(child_firstname) %>%
  kable("latex", col.names = c("CSPS", "Interview IDs", "Child ID", "Child name", "Form name")) %>%
  row_spec(0, bold=T) %>%
  column_spec(2, width = "3in")
```

\vspace{2em}

```{r, echo=F}
# display number
DN <- add_one(DN)
```

```{r, echo=F}
#Number of children with diarrhea >14 days or blood/mucus in stool:
#Number of children with respiratory rate >50 breaths/minute
```

## Anthro and Treatment weight discrepancy (>0.5 kg difference) (Display `r DN`)
```{r, echo=F, message=F, warning=F}
# merge together treatment and anthro
left_join(
  # anthro weight
  pluck(df_list, "anthro") %>%
    filter(time_point=="baseline") %>%
    select(csps_fra, child_firstname, childID, anthro_weight=weight),
  
  # treatment weight
  pluck(df_list, "treatment") %>%
    select(childID, child_weight),
  
  by="childID"
) %>%
  mutate(change_weight = round(abs(anthro_weight-child_weight), digits = 2)) %>%
  filter(change_weight>.5) %>%
  kable("latex", col.names = c("CSPS", "Child name", "Child ID", "Anthro wt", "Treat wt", "Difference (kg)")) %>%
  row_spec(0, bold=T)
```