---
title: "SAM Weekly Report"
subtitle:
- <h1><u>CONFIDENTIAL-DO NOT DISSEMINATE</u></h1>
author: "Will Godwin"
date: "`r format(Sys.time(), '%d %B %Y')`"
geometry: margin=2cm
header-includes:
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{wrapfig}
- \usepackage{float}
- \usepackage{colortbl}
- \usepackage{pdflscape}
- \usepackage{tabu}
- \usepackage{threeparttable}
- \usepackage{threeparttablex}
- \usepackage[normalem]{ulem}
- \usepackage{makecell}
- \usepackage{xcolor}
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = paste0(substr(inputFile,1,nchar(inputFile)-4), "_", Sys.Date(),'.pdf')) })
always_allow_html: yes
output:
  pdf_document:
    toc: true
    toc_depth: 2
    template: default.latex
---

```{r, echo=FALSE}
#Purpose: validate incoming data collected for GAMIN study

#Additions to make:

```

```{r setup, include=FALSE}
# clear memory
rm(list=ls())
options(max.print = 10000)
date <- format(Sys.Date(), "%d%b%Y")
#date <- "20May2020"

#disable scientific notation
options(scipen = 999)

# configure directories, load libraries and base functions
source(paste0(here::here(), "/monitoring/code/functions/config.R"))

#load utility package full of necessary functions
#devtools::load_all('~/Desktop/utility/')
```

```{r read data, include=F}
source(paste0(code_dir, "read_data.R"), local = T)
```

```{r overview, include=F}
# eligibility criteria
el_crit <- c("abx_use", "clin_comp", "inpatient", "edema", "growth_faltering_illness", 
             "prior__admission", "feeding", "Study_area", "available", "consent")

# create screened indicator
pluck(df_list, "eligibility") %<>%
  mutate(screened = if_else(!duplicated(childID) | is.na(childID), 1, 0),
         eligible = if_else(str_detect(inclusion_criteria, "consent"), 1, 0),
         refused = if_else(str_detect(inclusion_criteria, "consent"), 0, 1), # need to edit this once we know what refusal looks like
         enrolled = if_else(str_detect(inclusion_criteria, "consent"), 1, 0),
         excluded_reasons = setdiff(inclusion_criteria, el_crit))

# find reasons for exclusion

#tabulate the indicators and create table
temp.table <- 
  bind_rows(
    pluck(df_list, "eligibility") %>%
    group_by(CSPS=csps) %>%
    summarise(Screened = sum(screened),
              Eligible = sum(eligible),
              Refused = sum(refused),
              Enrolled = sum(enrolled)),
    pluck(df_list, "eligibility") %>%
    summarise(Screened = sum(screened),
              Eligible = sum(eligible),
              Refused = sum(refused),
              Enrolled = sum(enrolled)) %>%
    mutate(CSPS="Overall")
  ) %>%
  kable("latex", align = "c") %>%
  row_spec(0, bold=T)

#tabulate the indicators for past 7 days and create table
temp.table2 <- 
  bind_rows(
    pluck(df_list, "eligibility") %>%
    filter(Sys.Date() - interview_date < 7) %>%
    group_by(CSPS=csps) %>%
    summarise(Screened = sum(screened),
              Eligible = sum(eligible),
              Refused = sum(refused),
              Enrolled = sum(enrolled)),
    pluck(df_list, "eligibility") %>%
    filter(Sys.Date() - interview_date < 7) %>%
    summarise(Screened = sum(screened),
              Eligible = sum(eligible),
              Refused = sum(refused),
              Enrolled = sum(enrolled)) %>%
    mutate(CSPS="Overall")
  ) %>%
  kable("latex", align = "c") %>%
  row_spec(0, bold=T)
```

\newpage

# Overview
Data exported from CommCare on **`r format(Sys.time(), '%d %B %Y')`**

## Enrollment counts-total (Display 1): `r  temp.table`

## Enrollment counts-past 7 days (Display 2): `r  temp.table2`

\vspace{2em}

## Enrollment over time (Display 4)
```{r time series enrollment plot, echo=F, warning=F, message=F}
#daily enrollments over time
total_perday <- pluck(df_list, "eligibility") %>%
  group_by(interview_date) %>%
  summarise(Screened = sum(screened), 
            Eligible = sum(eligible),
            Enrolled = sum(enrolled))
  
#Melt to long for ggplot
total_perday %<>%
  gather(key = "Key", value = "Value", Screened, Eligible, Enrolled) %>%
  group_by(Key) %>%
  mutate(total=cumsum(Value)) %>%
  arrange(Key, interview_date)

#plot
total_perday$Step <- factor(total_perday$Key, levels=c("Screened", "Eligible", "Enrolled"))
ggplot(total_perday, aes(x = interview_date, y = as.integer(total), color = Step)) +  
  scale_color_brewer(palette="Set1", name="") +
  geom_line(alpha=.5) +
  geom_point() +
  #geom_text(aes(label=count), vjust=-0.3, size=3.5) +
  xlab("Date") +
  ylab("Total participants") +
  scale_y_continuous(breaks= pretty_breaks()) +
  scale_x_date(labels = date_format("%m/%d"), breaks = date_breaks("1 day")) +
  theme(legend.title = element_blank()) +
  #scale_color_discrete(name="") +
  theme_bw()
```

# Baseline characteristics
```{r, echo=F, message=F}
#calculate percent female
female <- pluck(df_list, "baseline") %>%
  mutate(sex2=if_else(sex=="male", 0, 1)) %>%
  summarize(Female=percent(mean(sex2, na.rm = T)))

#calculate percent currently breastfeeding
breastfed <- pluck(df_list, "baseline") %>%
  mutate(breast_fed=case_when(
    breastfeed == 1 ~ 1,
    breastfeed == 2 ~ 0
  )) %>%
  summarize("Breastfeeding"=percent(mean(breast_fed, na.rm = T)))

#calculate age groups: 1-5 months, 6-11 months, 12-23 months, 24-59 months
ages <- pluck(df_list, "baseline") %>%
  mutate(
    child_dob = as.Date(child_dob),
    age_months = as.integer(age_months),
    age_months = ifelse(Dob_known==1, difftime(Sys.Date(), child_dob)/30, age_months)) %>%
  mutate(age_months2 = case_when(
    age_months<6 ~ "1-5 months",
    age_months<12 ~ "6-11 months",
    age_months<24 ~ "12-23 months",
    age_months<60 ~ "24-59 months"
  ),
    num=1,
    id = row_number()) %>%
  select(age_months2, num, id) %>%
  spread(key = age_months2, value=num, fill=0) %>%
  summarise_if(is.numeric, mean) %>%
  mutate_all(percent) %>%
  select(contains("months"))
  #select("1-5 months", "6-11 months", "12-23 months", "24-59 months")

#get total number
total <- pluck(df_list, "baseline") %>%
  summarise(Total=n())

#bind together and table
bind_cols(female, ages, breastfed, total) %>%
  kable("latex") %>%
  row_spec(0, bold=T)
  # column_spec(c(2,3,4,5), background = "#f0f0f0") %>%
  # row_spec(c(0), bold=TRUE) %>%
  # column_spec(c(2), border_left = T) %>%
  # column_spec(c(5), border_right = T)
```
Breastfeeding = currently breastfeeding.

## Age Distribution
```{r, echo=F, message=F}
#age histogram
pluck(df_list, "anthro") %>%
  mutate(age_months = ifelse(Dob_known==1, difftime(Sys.Date(), child_dob)/30, age_months)) %>%
  ggplot(aes(age_months)) +
  geom_histogram() +
  theme_bw() +
  #scale_x_continuous(breaks = seq(0,60,6)) +
  xlab("Age (Months)") +
  ylab("Count")
```

\vspace{2em}

# Anthropometry
```{r, echo=F, message=F}
source(paste0(code_dir, "plot_anthro.R"), local = T)
# function that produces sum and percent of binary vector input
sum_n_percent <- function(x){
  s <- sum(x)
  
  per <- percent(sum(x)/length(x))
  
  return(paste0(s, " (", per, ")"))
}

# tabulate anthro indicators
pluck(df_list, "anthro") %>%
  mutate(whz3=if_else(whz_zscore < -3, 1, 0),
         muac11=if_else(muac < 11.5, 1, 0),
         waz3=if_else(waz_zscore < -3, 1, 0),
         haz3=if_else(haz_zscore < -3, 1, 0)) %>%
  group_by(csps_fra) %>%
  summarise(sum_n_percent(whz3),
            sum_n_percent(muac11),
            sum_n_percent(waz3),
            sum_n_percent(haz3)) %>%
  kable("latex", col.names = c("CSPS", "WHZ < -3", "MUAC < 11.5", "WAZ < -3",
                               "HAZ < -3")) %>%
  row_spec(0, bold=T)
```
Total and percentage of participants that report WAZ < -3 SD (standard deviation), MUAC < -11.5 cm, WHZ < -3 SD, and HAZ < -3 SD.

## Weight versus age
```{r, echo=F, message=F, fig.height = 4.35, fig.width = 6.5}
#plot wfa males
p_male_wfa
```

```{r, echo=F, message=F, fig.height = 4.35, fig.width = 6.5}
#plot wfa females
p_female_wfa
```


## Height versus age
```{r, echo=F, message=F, fig.height = 4.35, fig.width = 6.5}
#plot hfa males
p_male_hfa
```

```{r, echo=F, message=F, fig.height = 4.35, fig.width = 6.5}
#plot hfa females
p_female_hfa
```


## Weight versus height
```{r, echo=F, message=F, warning=F, fig.height = 4.35, fig.width = 6.5}
#plot wfh males: 0-2 years
p_male_wfh_2
```

```{r, echo=F, message=F, warning=F, fig.height = 4.35, fig.width = 6.5}
#plot wfh females: 0-2 years
p_female_wfh_2
```


## MUAC versus age
```{r, echo=F, message=F, warning=F, fig.height = 4.35, fig.width = 6.5}
#plot mfa males
p_male_mfa
```

```{r, echo=F, message=F, warning=F, fig.height = 4.35, fig.width = 6.5}
#plot mfa females
p_female_mfa
```

# Treatment
```{r, echo=F}
bind_rows(
  pluck(df_list, "treatment") %>%
    group_by(CSPS=csps_fra) %>%
    summarise("Total treated"=sum(admin_treatment)),
  pluck(df_list, "treatment") %>%
    summarise("Total treated"=sum(admin_treatment)) %>%
    mutate(CSPS="Overall")
) %>%
  kable("latex") %>%
  row_spec(0, bold=T)
```


# Malaria (Rapid Diagnostic Test results)
```{r, echo=F}
# number of TDR per CSPS
pluck(df_list, "malaria") %<>%
  mutate(total=1,
         positive=if_else(malaria_rdt_result=="positive", 1, 0),
         negative=if_else(malaria_rdt_result=="negative", 1, 0),
         missing=if_else(malaria_rdt_result=="not_done", 1, 0),
         invalid=if_else(malaria_rdt_result=="invalid", 1, 0))

bind_rows(
  pluck(df_list, "malaria") %>%
    group_by(CSPS=csps_fra, time_point) %>%
    summarise(sum(total),
              sum_n_percent(positive),
              sum_n_percent(negative),
              sum_n_percent(missing),
              sum_n_percent(invalid),
              sum_n_percent(hb_test)),
  pluck(df_list, "malaria") %>%
    summarise(sum(total),
              sum_n_percent(positive),
              sum_n_percent(negative),
              sum_n_percent(missing),
              sum_n_percent(invalid),
              sum_n_percent(hb_test)) %>%
    mutate(CSPS="Overall")
) %>%
  kable("latex", col.names = c("CSPS", "Timepoint", "Total", "Positives", "Negatives",
                               "Missing", "Invalid", "HB Test")) %>%
  row_spec(0, bold=T)
```

# Rectal swabs
```{r, echo=F}
bind_rows(
  pluck(df_list, "rectal") %>%
    group_by(CSPS=csps_fra) %>%
    summarise("Rectal swabs"=sum(rectal_alloc)),
  pluck(df_list, "rectal") %>%
    summarise("Rectal swabs"=sum(rectal_alloc)) %>%
    mutate(CSPS="Overall")
) %>%
  kable("latex") %>%
  row_spec(0, bold=T)
```

# Discharge
```{r, echo=F}
# diplay discharge reason
pluck(df_list, "discharge") %>%
  select(csps_fra, childID, child_firstname, date_of_discharge, reason_for_discharge) %>%
  kable("latex", col.names = c("CSPS", "Child ID", "Child first name", "Date of discharge", "Reason")) %>%
  row_spec(0,bold=TRUE)
```


\newpage

# Child ID and sample ID validation
## Missing forms
```{r, echo=F}
#missing form function
find_missing <- function(df1, df2, df_list) {
  #find all IDs in df2
  ids2 <- pluck(df_list, df2) %>%
    filter(!is.na(childID) & !duplicated(childID)) %>% pull(unique(childID))
  
  #find the IDs in df1 but not df2
  ids1 <- pluck(df_list, df1) %>%
    filter(!is.na(childID)) %>%
    pull(unique(childID))
  ids_miss <- setdiff(ids1, ids2)

  #subset & table
  pluck(df_list, df1) %>%
    filter(childID %in% ids_miss) %>% select(childID, child_firstname) %>%
    kable("latex", col.names = c("Child ID", "Child first name")) %>%
    row_spec(0,bold=TRUE)
}

#run missing form function for different combinations
check1.tab <- find_missing(df1 = "eligibility", df2 = "baseline", df_list = df_list)
check2.tab <- find_missing(df1 = "baseline", df2 = "eligibility", df_list = df_list)
check3.tab <- find_missing(df1 = "baseline", df2 = "treatment", df_list = df_list)
check4.tab <- find_missing(df1 = "eligibility", df2 = "treatment", df_list = df_list)
check5.tab <- find_missing(df1 = "treatment", df2 = "eligibility", df_list = df_list)
check6.tab <- find_missing(df1 = "eligibility", df2 = "anthro", df_list = df_list)
check7.tab <- find_missing(df1 = "eligibility", df2 = "malaria", df_list = df_list)
#check8.tab <- find_missing(df1 = "malaria", df2 = "eligibility", df_list = df_list)
check9.tab <- find_missing(df1 = "eligibility", df2 = "rectal", df_list = df_list)
```

### IDs in __eligibility__ form but not in __baseline__ form:
`r check1.tab`
### IDs in **baseline** form but not in **eligibility** form:
`r check2.tab`
### IDs in **eligibility** form but not in **anthro** form:
`r check6.tab`
### IDs in **baseline** form but not in **treatment** form:
`r check3.tab`
### IDs in **eligibility** form but not in **treatment** form:
`r check4.tab`
### IDs in **treatment** form but not in **eligibility** form:
`r check5.tab`
### IDs in **eligibility** form but not in **malaria** form:
`r check7.tab`
### IDs in **eligibility** form but not in **rectal swab** form:
`r check9.tab`

## Duplicate IDs
### Child IDs
```{r, echo=F, message=F, warning=F}
#duplicate form function
find_duplicate_chids1 <- function(df_name, df_list){
  #duplicated ids in given form
  ids <- pluck(df_list, df_name) %>%
    filter(!is.na(childID) & duplicated(childID)) %>% 
    pull(unique(childID))
  
  #isolate the IDs and collapse with the interview keys
  pluck(df_list, df_name) %>%
    filter(childID %in% ids) %>%
    group_by(childID) %>%
    summarize(id=paste(d, collapse = "| |")) %>%
    select(id, childID) %>%
    mutate(form=df_name)
}

#find IDs that are duplicated
forms <- c("eligibility", "baseline", "anthro", "malaria", "treatment", "rectal", "followup")
map_df(forms, find_duplicate_chids1, df_list) %>%
  filter(!is.na(childID)) %>%
  kable("latex", col.names = c("Interview IDs", "Child ID", "Child first name", "Form name")) %>%
  row_spec(0, bold=T)
```
